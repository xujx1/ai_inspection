# AI智能巡检系统核心功能流程

## 流程描述

AI智能巡检系统的核心功能流程包含标签配置、Prompt模板管理、自动化巡检执行、AI智能分析、结果展示等完整链路。系统通过定时任务机制自动执行巡检任务，利用Playwright浏览器自动化技术进行页面截图采集，调用阿里云通义千问多模态大模型进行智能分析，最终生成结构化的检测结果。整个流程采用事件驱动和异步处理架构，确保系统的高性能和稳定性。

该功能采用前后端分离架构实现，前端使用React+Ant Design技术栈提供用户界面，后端基于Spring Boot框架提供API服务。数据存储采用H2内存数据库（开发环境）或MySQL关系数据库（生产环境），通过MyBatis框架进行数据访问。系统集成多个外部服务，包括DashScope AI服务、Playwright浏览器引擎等，通过统一的配置管理和异常处理机制确保服务的可靠性。

## 核心流程对比表

基于实际功能分析和UI体验的结果：

| 流程步骤 | 标签管理流程 | Prompt管理流程 | 巡检执行流程 | AI分析流程 |
|---------|-------------|---------------|-------------|-----------|
| **初始化** | ✅ 加载标签列表 | ✅ 加载Prompt列表 | ✅ 定时任务触发 | ✅ 接收巡检请求 |
| **配置验证** | ✅ 验证标签信息完整性 | ✅ 验证Prompt模板有效性 | ✅ 验证登录凭证和URL | ✅ 验证图片和参数 |
| **数据处理** | ✅ 加密存储敏感信息 | ✅ 解析模板参数 | ✅ 执行页面自动化操作 | ✅ 调用多模态AI服务 |
| **结果生成** | ✅ 返回操作结果 | ✅ 保存模板配置 | ✅ 生成截图和数据 | ✅ 输出差异分析结果 |
| **状态更新** | ✅ 更新标签状态 | ✅ 更新模板状态 | ✅ 更新巡检记录 | ✅ 保存分析结果 |
| **异常处理** | ✅ 显示友好错误提示 | ✅ 模板语法校验 | ✅ 超时和失败重试 | ✅ AI服务异常处理 |

## 操作步骤详解

### 流程入口

- 导航指引：通过Web浏览器访问系统主页(index.html)，系统自动跳转到标签管理页面(tag.html)，用户可通过导航菜单访问其他功能模块
- 页面识别：主要包含三个核心页面：标签管理(tag.html)、Prompt管理(prompt.html)、巡检结果管理(inspection.html)
- 界面元素：现代化的React界面，采用Ant Design组件库，包含数据表格、查询表单、编辑弹窗、操作按钮等交互元素
- 操作触发点：用户通过点击菜单、按钮、链接等方式触发各种功能操作，系统通过事件监听机制响应用户交互
- 前置检查：系统自动检查后端API服务可用性，如API不可用则显示友好提示，支持离线模式下的界面预览
- 技术架构：前端采用CDN方式加载React、Ant Design等依赖库，通过Babel转译JSX代码，支持现代浏览器的ES6+特性

### 流程权限

- 权限检查点：目前版本为单机版本，暂未实现复杂的权限验证机制，所有功能对用户开放
- 数据安全表现：敏感信息如密码在界面显示时进行脱敏处理，显示为"***"形式
- API调用安全：支持CORS跨域访问，API接口采用统一的错误处理机制

## 流程步骤详情

### 1. 系统初始化流程：必要步骤，系统自动执行

1. **前端资源加载**：必要步骤，浏览器自动执行
   - 用户通过浏览器访问系统首页，浏览器开始加载HTML、CSS、JavaScript等静态资源
   - 系统加载React、ReactDOM、Ant Design、Babel等核心依赖库，通过CDN方式提高加载速度
   - 操作结果：页面基础框架完成加载，准备渲染具体功能组件
   - 相关界面元素：
     * 加载动画：显示"AI 巡检管理系统"标题和加载进度指示器
     * 渐进式加载：通过CSS动画实现平滑的界面过渡效果
     * 错误处理：如资源加载失败，显示相应的错误提示信息

2. **React应用初始化**：必要步骤，系统自动执行
   - React应用容器初始化，创建虚拟DOM树，初始化组件状态管理
   - Ant Design组件库初始化，加载主题配置和图标资源
   - 操作结果：React应用环境准备就绪，开始渲染具体功能界面
   - 技术实现：
     * 使用ReactDOM.render方法挂载应用到root元素
     * 通过useState和useEffect hooks管理组件状态和副作用
     * 支持开发模式的热重载和调试工具集成

3. **API服务连接检测**：必要步骤，系统自动执行
   - 系统自动检测后端API服务的可用性，尝试调用健康检查接口
   - 根据检测结果决定是否启用API交互功能或显示离线模式提示
   - 操作结果：确定系统运行模式，为用户提供相应的功能体验
   - 连接逻辑：
     * 成功连接：启用完整的CRUD功能，支持数据的增删改查操作
     * 连接失败：启用演示模式，显示静态界面和模拟数据
     * 超时处理：设置合理的超时时间，避免长时间等待影响用户体验

### 2. 标签管理流程：核心功能，用户主动操作

4. **标签列表加载**：必要步骤，页面自动执行
   - 系统调用/api/tag/query接口获取标签列表数据，支持分页和排序
   - 数据加载过程中显示加载状态，完成后更新表格组件显示
   - 操作结果：标签列表以表格形式展示，包含所有必要的标签信息
   - 数据结构：
     * ID：唯一标识符，用于数据库主键和前端key值
     * 业务类型：业务分类编码，如"dashboard"、"user_center"等
     * 标签名称：友好显示名称，如"数据看板"、"用户中心"等
     * 标签描述：详细说明信息，支持多行文本显示
     * 登录凭证：账号、密码（脱敏显示）、登录URL
     * 巡检配置：巡检URL、检测策略等
     * 时间信息：创建时间、更新时间，格式化显示

5. **标签新增编辑操作**：可选步骤，用户主动触发
   - 用户点击"新增标签"按钮或表格行的"编辑"链接，系统弹出编辑弹窗
   - 弹窗包含完整的表单字段，支持数据验证和实时校验
   - 操作结果：成功保存后关闭弹窗，刷新列表数据，显示操作成功提示
   - 表单字段详情：
     * 业务类型：文本输入框，必填项，建议使用英文字母和下划线
     * 标签名称：文本输入框，必填项，用于显示的友好名称
     * 标签描述：多行文本域，选填项，详细说明标签用途
     * 登录账号：文本输入框，用于自动化登录的用户名
     * 登录密码：密码输入框，支持显示/隐藏切换，加密存储
     * 登录URL：文本输入框，目标系统的登录页面地址
     * 巡检URL：文本输入框，需要进行巡检的目标页面地址
   - 数据验证规则：
     * 必填字段验证：业务类型和标签名称不能为空
     * 格式验证：URL字段需符合有效的URL格式
     * 唯一性验证：业务类型在系统内需保持唯一性
     * 长度限制：各字段设置合理的长度限制，防止数据溢出

6. **标签关联功能访问**：可选步骤，用户主动触发
   - 用户点击表格行的"去管理"按钮，系统切换到管理视图
   - 管理视图采用Tab页面设计，包含"巡检管理"和"Prompt管理"两个标签页
   - 操作结果：在统一界面中集成多个功能模块，提供一体化的管理体验
   - 界面切换逻辑：
     * 巡检管理：通过iframe嵌入inspection.html，自动传递标签参数
     * Prompt管理：通过iframe嵌入prompt.html，自动传递标签参数
     * 参数传递：通过URL查询参数传递tag、tagName、hideTagSelect等信息
     * 返回机制：提供"返回标签列表"按钮，支持快速返回主界面

### 3. Prompt模板管理流程：辅助功能，用户主动操作

7. **Prompt模板加载**：必要步骤，页面自动执行
   - 系统调用/api/prompt/query接口获取Prompt模板列表，支持按标签筛选
   - 同时调用/api/tag/valid接口获取有效标签列表，用于下拉框选项
   - 操作结果：Prompt列表和标签选项同时加载完成，界面准备就绪
   - 数据展示：
     * Prompt列表：以表格形式展示所有模板信息
     * 标签下拉框：显示所有可用的业务标签供用户选择
     * 筛选联动：选择标签后自动筛选对应的Prompt模板

8. **Prompt模板编辑**：可选步骤，用户主动触发
   - 用户点击"新增Prompt"或"编辑"按钮，弹出模板编辑弹窗
   - 弹窗包含业务标签选择、方法名输入、模板内容编辑等字段
   - 操作结果：保存成功后更新列表数据，关闭弹窗显示成功提示
   - 模板字段说明：
     * 业务类型：下拉选择或自动填充，关联到具体的业务标签
     * 方法名：文本输入，标识具体的检测方法，如"login"、"dashboard"等
     * Prompt名称：友好的模板名称，便于识别和管理
     * Prompt内容：多行文本编辑器，支持大文本内容的编辑和格式化
   - 模板语法：
     * 支持参数占位符，如${workNo}、${url}等动态参数
     * 支持条件逻辑，根据不同场景生成不同的提示词
     * 内置常用模板片段，提高编辑效率

### 4. 自动化巡检执行流程：核心流程，定时自动执行

9. **定时任务触发**：必要步骤，系统自动执行
   - Spring Boot定时任务组件每60秒执行一次巡检任务扫描
   - 查询数据库中状态为"page"类型的巡检记录，获取待执行任务列表
   - 操作结果：系统获得需要执行巡检的任务清单，准备开始执行
   - 任务调度机制：
     * 使用@Scheduled注解配置固定频率执行
     * 支持cron表达式的灵活调度配置
     * 任务执行状态跟踪，避免重复执行
     * 异常任务的重试和告警机制

10. **页面自动化执行**：必要步骤，系统自动执行
    - 系统创建Playwright浏览器实例，配置浏览器参数和上下文环境
    - 根据标签配置自动执行登录流程，包括页面访问、表单填写、登录验证
    - 操作结果：成功登录目标系统并维持会话状态，准备进行页面巡检
    - 自动化流程：
      * 浏览器启动：创建无头浏览器实例，配置窗口大小和用户代理
      * 登录处理：自动填写用户名密码，点击登录按钮，等待登录完成
      * 会话维持：保存Cookie和LocalStorage，确保后续访问的身份有效性
      * 页面导航：访问巡检目标页面，等待页面完全加载

11. **页面截图采集**：必要步骤，系统自动执行
    - 浏览器访问巡检目标页面，等待页面元素完全加载
    - 执行页面截图操作，生成高质量的PNG格式图片文件
    - 操作结果：获得当前页面的完整截图，作为AI分析的输入数据
    - 截图策略：
      * 智能等待：等待关键元素出现，确保页面内容完整加载
      * 全页面截图：支持长页面的完整截图，包含滚动区域
      * 图片优化：适当压缩图片大小，平衡质量和传输效率
      * 存储管理：图片文件的命名规范和存储路径管理

### 5. AI智能分析流程：核心流程，系统自动执行

12. **多模态AI调用**：必要步骤，系统自动执行
    - 系统调用阿里云DashScope多模态大模型服务，传入当前截图和历史截图
    - 根据业务标签和方法名查询对应的Prompt模板，构建完整的分析请求
    - 操作结果：AI服务返回详细的图像分析结果，包含差异点和分析结论
    - AI分析配置：
      * 模型选择：使用qwen-vl-max多模态模型，支持图像和文本理解
      * 参数配置：temperature、top_p等生成参数的优化配置
      * 超时控制：设置合理的超时时间，避免长时间等待
      * 重试机制：网络异常或服务不可用时的重试策略

13. **差异结果解析**：必要步骤，系统自动执行
    - 解析AI返回的JSON格式分析结果，提取差异指标和详细信息
    - 应用数据清洗规则，过滤正常波动范围内的数据，减少误报
    - 操作结果：生成结构化的差异报告，标识真正需要关注的异常
    - 结果处理逻辑：
      * JSON解析：从AI返回的文本中提取有效的JSON数据
      * 数据过滤：根据预设规则过滤"无需比较"、"在合理波动范围内"等正常情况
      * 差异分级：根据差异严重程度进行分级，如警告、错误、严重等
      * 结果标准化：统一差异指标的数据格式和字段结构

14. **智能阈值比较**：可选步骤，根据数据类型自动执行
    - 对于数值类型的差异，调用阈值比较工具进行智能判断
    - 支持百分比阈值和绝对值阈值两种比较模式，根据业务场景选择
    - 操作结果：为数值差异提供更精确的判断结果和建议阈值
    - 比较工具功能：
      * 百分比阈值：计算相对变化幅度，适用于比例性指标
      * 绝对值阈值：比较数值差的绝对大小，适用于绝对性指标
      * 动态阈值：基于历史数据计算动态阈值范围
      * 业务规则：支持不同业务场景的定制化阈值规则

### 6. 结果存储与展示流程：必要步骤，系统自动执行

15. **巡检结果保存**：必要步骤，系统自动执行
    - 将AI分析结果、截图信息、执行状态等数据保存到数据库
    - 更新巡检记录的状态标识，标记为已检查(Y/N)或执行失败(U)
    - 操作结果：巡检数据完整保存，支持历史查询和趋势分析
    - 数据存储结构：
      * 基础信息：工号、标签、方法名、执行时间等
      * 请求数据：Prompt内容、截图文件名、请求参数等
      * 结果数据：AI分析结果、差异列表、检查状态等
      * 错误信息：执行异常的详细错误信息和堆栈跟踪

16. **结果列表展示**：可选步骤，用户主动查看
    - 用户访问巡检结果管理页面，系统加载并展示巡检历史记录
    - 支持多维度筛选查询，包括业务类型、工号、检查结果、巡检方式等
    - 操作结果：用户可全面了解系统巡检状态和历史趋势
    - 展示功能：
      * 列表视图：以表格形式展示巡检记录，支持排序和分页
      * 状态标识：通过颜色标签直观显示通过、不通过、未检查状态
      * 差异详情：可展开查看具体的差异指标和分析结果
      * 图片查看：支持点击查看当前截图和历史截图的对比

17. **差异详情分析**：可选步骤，用户主动查看
    - 点击错误信息列的展开按钮，查看详细的差异分析结果
    - 以结构化的方式展示每个差异指标的期望值、实际值、差异原因
    - 操作结果：用户获得清晰的差异分析报告，便于问题定位和处理
    - 详情展示：
      * 指标分类：按照指标类型进行分类展示，如数据指标、界面指标等
      * 差异对比：清晰对比期望值和实际值，突出差异部分
      * 原因分析：显示AI分析得出的差异原因和影响评估
      * 操作建议：根据差异类型提供相应的处理建议和解决方案

### 7. 异常处理与恢复流程：可选步骤，根据实际情况执行

18. **网络异常处理**：可选步骤，系统自动执行
    - API调用失败时自动重试3次，每次间隔递增，避免服务过载
    - 重试失败后记录错误日志，用户界面显示友好的错误提示信息
    - 操作结果：系统具备网络异常的自恢复能力，保证服务稳定性
    - 异常处理策略：
      * 超时处理：设置合理的请求超时时间，避免长时间等待
      * 重试机制：指数退避的重试策略，逐步增加重试间隔
      * 降级处理：核心服务异常时的功能降级和备用方案
      * 用户通知：通过消息提示、状态指示等方式通知用户异常状态

19. **AI服务异常处理**：可选步骤，系统自动执行
    - DashScope API调用失败时记录详细错误信息，包括错误码和错误描述
    - 系统标记该次巡检为失败状态，保留原始请求数据便于后续重试
    - 操作结果：确保AI服务异常不影响整体系统稳定性
    - 服务监控：
      * 健康检查：定期检查AI服务的可用性和响应时间
      * 错误分类：根据错误类型进行分类处理和告警
      * 服务降级：AI服务不可用时的备用检测方案
      * 数据恢复：服务恢复后的数据补偿和重新处理机制

20. **数据一致性保障**：持续执行，系统自动维护
    - 定期检查数据库数据完整性，发现异常数据及时修复
    - 保持前端展示数据与后端存储数据的一致性，避免脏数据
    - 操作结果：系统数据保持高质量和一致性，确保分析结果可靠
    - 一致性机制：
      * 事务管理：使用数据库事务确保数据操作的原子性
      * 数据校验：定期执行数据一致性校验和修复脚本
      * 备份恢复：定期备份重要数据，支持数据恢复和回滚
      * 监控告警：监控数据质量指标，异常时及时告警和处理
