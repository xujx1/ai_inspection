# AI智能巡检系统 - 外部依赖管理

## AI智能巡检系统对外部接口的依赖

### 1.1 外部服务依赖

| 服务名称 | 服务类型 | 版本 | 用途 | 调用方式 |
|---------|---------|------|------|---------|
| DashScope AI服务 | HTTPS API | 2.20.0 | 阿里云通义千问多模态大模型，提供图像和文本智能分析 | SDK调用 |
| H2 Database | 嵌入式数据库 | 2.1+ | 内存数据库，提供数据持久化和查询服务 | JDBC连接 |
| Playwright Browser | 自动化框架 | 1.47.0 | Web浏览器自动化，提供页面截图和操作能力 | 本地调用 |

#### 1.1.1 DashScope AI服务（阿里云通义千问）

DashScope是阿里云提供的通义千问大模型服务平台，为本应用提供多模态AI分析能力，支持图像理解、文本生成、智能对比等核心功能。

**基本信息**
- **服务名称**: DashScope多模态AI服务
- **服务类型**: 阿里云大模型API
- **主要实现类**: `PicCompareServiceImpl`
- **认证方式**: API Key认证

**配置参数**
| 参数名 | 配置值 | 环境 | 说明 |
|--------|--------|------|------|
| dashscope.api.model | qwen-vl-max | 所有环境 | 使用的AI模型版本 |
| dashscope.api.key | xxx | 开发/测试 | API访问密钥 |
| dashscope.api.url | https://dashscope.alibaba-inc.com/api/v1 | 所有环境 | API服务端点 |

**主要功能**
1. **多模态图像分析**: 支持图像内容理解和差异检测
2. **智能文本生成**: 基于图像内容生成结构化分析报告
3. **差异识别**: 智能识别两张图片之间的关键差异点
4. **上下文理解**: 结合业务场景进行智能判断和分析

**核心方法**
- `MultiModalConversation`: 多模态对话接口，支持图像和文本输入
- `MultiModalMessage`: 消息构建器，支持系统提示词和用户输入
- `GenerationResult`: 结果解析器，提取AI分析的结构化数据

**使用场景**
- **页面巡检分析**: 对比页面截图，识别数据变化和异常
- **智能差异检测**: 自动识别关键业务指标的变化
- **异常原因分析**: 基于AI智能分析，提供异常原因和建议
- **质量评估**: 对巡检结果进行智能质量评估和过滤

**监控和日志**
- **API调用监控**: 记录每次AI服务调用的请求参数和响应结果
- **性能统计**: 监控AI服务响应时间和成功率
- **错误处理**: 完整的异常捕获和重试机制
- **成本控制**: 合理控制AI服务调用频次，降低使用成本

**典型调用示例**
```java
// 构建多模态对话请求
MultiModalConversation conv = new MultiModalConversation(
    Protocol.HTTP.getValue(), 
    dashScopeConfig.getUrl()
);

// 构建系统提示词
String systemPrompt = "你是一个严谨的端到端巡检测试专家...";
MultiModalMessage systemMessage = MultiModalMessage.builder()
    .role(Role.SYSTEM.getValue())
    .content(Collections.singletonList(
        Collections.singletonMap("text", systemPrompt)
    ))
    .build();

// 构建用户消息（包含图像）
MultiModalMessage userMessage = MultiModalMessage.builder()
    .role(Role.USER.getValue())
    .content(Arrays.asList(
        Collections.singletonMap("image", currentImageBase64),
        Collections.singletonMap("image", lastImageBase64),
        Collections.singletonMap("text", "请分析这两张图片的差异")
    ))
    .build();

// 执行AI分析
GenerationResult result = conv.call(
    GenerationParam.builder()
        .model(dashScopeConfig.getModel())
        .messages(Arrays.asList(systemMessage, userMessage))
        .resultFormat(GenerationParam.ResultFormat.MESSAGE)
        .build()
);
```

### 1.2 第三方库依赖

| 库名称 | 版本 | 用途 | 封装/使用方式 |
|--------|------|------|---------------|
| React | 18 | 前端UI框架，提供组件化开发能力 | CDN直接引入，无需构建打包 |
| Ant Design | 4.24.15 | 企业级UI组件库，提供丰富的交互组件 | CDN引入，通过全局变量使用 |
| Babel Standalone | 最新版 | JSX语法转译，支持浏览器端实时编译 | 浏览器端实时转译JSX代码 |
| Playwright | 1.47.0 | Web自动化测试框架，提供浏览器操作能力 | Java集成，通过PageScreenshotProcessor使用 |
| FastJSON | 2.0.58 | 高性能JSON解析库，处理AI服务响应数据 | 直接调用API进行序列化和反序列化 |
| Apache Commons | 3.12.0 | 通用工具库，提供字符串和集合操作工具 | 工具类静态方法调用 |

#### 1.2.1 前端依赖管理

**React生态系统**: 前端采用React 18框架，通过CDN方式引入，避免了复杂的构建配置。
- **React核心**: 提供组件化开发和状态管理能力
- **ReactDOM**: 负责DOM操作和页面渲染
- **Hooks支持**: 使用useState、useEffect等现代Hook特性

**UI组件库**: Ant Design 4.x提供完整的企业级组件支持
- **表格组件**: 支持排序、分页、筛选等高级功能
- **表单组件**: 提供数据验证和用户输入处理
- **弹窗组件**: 模态对话框支持复杂交互流程
- **导航组件**: Tab页面和菜单导航组件

#### 1.2.2 后端工具库

**Playwright自动化**: 通过Java SDK集成Playwright浏览器自动化能力
- **多浏览器支持**: 支持Chromium、Firefox、WebKit等主流浏览器
- **页面操作**: 自动登录、页面导航、元素交互等操作
- **截图功能**: 高质量页面截图，支持全页面和区域截图
- **智能等待**: 自动等待页面加载完成和元素出现

**JSON处理**: FastJSON提供高性能的JSON处理能力
- **对象序列化**: Java对象与JSON格式的双向转换
- **类型安全**: 泛型支持，确保类型安全的数据处理
- **性能优化**: 高性能解析器，适合大数据量处理
- **异常处理**: 完善的解析异常处理和容错机制

### 1.3 数据库依赖

| 数据库类型 | 版本 | 用途 | 连接配置 |
|-----------|------|------|---------|
| H2 Database | 2.1+ | 嵌入式关系数据库，主要业务数据存储 | 内存模式，自动初始化表结构 |

#### 1.3.1 H2数据库配置

H2数据库是一个轻量级的Java关系数据库，支持内存模式和文件模式，非常适合开发和测试环境使用。

**配置特点**
- **内存模式**: 数据存储在内存中，重启后数据重置
- **自动建表**: 应用启动时自动执行SQL脚本创建表结构
- **Web控制台**: 提供H2 Console用于数据库管理和查询
- **零配置**: 无需安装额外的数据库软件

**连接参数**
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=false
    driver-class-name: org.h2.Driver
    username: sa
    password: 
```

**表结构管理**
- **inspection_tag**: 巡检标签配置表，存储业务分类和登录信息
- **inspection_prompt**: AI提示词模板表，存储不同场景的Prompt配置
- **inspection_result**: 巡检结果表，存储巡检执行结果和AI分析数据

### 1.4 运行时依赖

| 依赖类型 | 名称 | 版本要求 | 说明 |
|---------|------|---------|------|
| JRE | Java Runtime | 11+ | Java运行时环境，支持现代Java特性 |
| 浏览器 | Chromium/Chrome | 最新版 | Playwright自动化所需的浏览器引擎 |
| 网络连接 | Internet | 稳定连接 | AI服务调用和CDN资源加载 |

#### 1.4.1 浏览器环境依赖

Playwright自动化框架需要浏览器环境支持：
- **浏览器安装**: Playwright会自动下载和管理所需的浏览器版本
- **系统依赖**: 根据操作系统自动安装必要的系统库
- **权限要求**: 需要读写临时文件和网络访问权限
- **资源管理**: 自动管理浏览器进程和资源清理

#### 1.4.2 网络环境要求

系统正常运行需要稳定的网络环境：
- **AI服务连接**: 访问阿里云DashScope API服务
- **CDN资源加载**: 前端框架和组件库的CDN资源
- **更新检查**: 定期检查依赖库的安全更新
- **监控上报**: 系统监控和日志数据上报

### 1.5 开发环境依赖

| 工具类型 | 名称 | 版本 | 用途 |
|---------|------|------|------|
| 构建工具 | Maven | 3.6+ | 项目构建和依赖管理 |
| IDE | IntelliJ IDEA / Eclipse | 最新版 | 开发环境和代码编辑 |
| 版本控制 | Git | 2.0+ | 代码版本管理 |
| API测试 | Postman / Curl | 最新版 | API接口测试和调试 |

#### 1.5.1 开发工具链

**构建和依赖管理**
- **Maven**: 项目构建、依赖管理、插件执行
- **Maven插件**: Spring Boot插件、编译器插件等
- **依赖仓库**: 中央仓库、阿里云镜像仓库

**开发和调试**
- **IDE支持**: Spring Boot开发插件、代码自动完成
- **热重载**: Spring Boot DevTools支持代码热重载
- **调试工具**: 断点调试、性能分析工具

#### 1.5.2 部署环境要求

**最小系统要求**
- **CPU**: 2核心以上
- **内存**: 4GB以上（推荐8GB）
- **磁盘**: 10GB可用空间
- **网络**: 稳定的互联网连接

**推荐系统配置**
- **CPU**: 4核心以上
- **内存**: 8GB以上
- **磁盘**: SSD存储，20GB以上
- **网络**: 专线连接，低延迟
