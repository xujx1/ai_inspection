# AI智能巡检系统 - 配置管理

## 配置管理

### 环境配置

#### 核心应用配置

| 配置项 | Development | Testing | Staging | Production |
|--------|-------------|---------|---------|------------|
| **server.port** | 8080 | 8080 | 8080 | 8080 |
| **spring.profiles.active** | dev | test | staging | prod |
| **logging.level.root** | DEBUG | INFO | WARN | ERROR |
| **app.env.type** | dev | test | staging | prod |

#### 数据库配置

| 配置项 | Development | Testing | Staging | Production |
|--------|-------------|---------|---------|------------|
| **spring.datasource.url** | jdbc:h2:mem:testdb | jdbc:h2:file:./data/test | jdbc:mysql://test-db:3306/ai_inspection | jdbc:mysql://prod-db:3306/ai_inspection |
| **spring.datasource.driver-class-name** | org.h2.Driver | org.h2.Driver | com.mysql.cj.jdbc.Driver | com.mysql.cj.jdbc.Driver |
| **spring.datasource.username** | sa | sa | ai_inspection | ai_inspection |
| **spring.datasource.password** | - | - | ${DB_PASSWORD} | ${DB_PASSWORD} |
| **spring.h2.console.enabled** | true | true | false | false |

#### AI服务配置

| 配置项 | Development | Testing     | Staging      | Production |
|--------|-------------|-------------|--------------|------------|
| **dashscope.api.model** | qwen-vl-max | qwen-vl-max | qwen-vl-max  | qwen-vl-max |
| **dashscope.api.key** | sk-dev-key  | sk-test-key | sk-staging-key | ${DASHSCOPE_API_KEY} |
| **dashscope.api.url** | xxx         | xxx         | xxx          |
| **dashscope.api.timeout** | 30000       | 30000       | 20000        | 15000 |

#### MyBatis配置

| 配置项 | Development | Testing | Staging | Production |
|--------|-------------|---------|---------|------------|
| **mybatis.configuration.cache-enabled** | true | true | true | true |
| **mybatis.configuration.lazy-loading-enabled** | true | true | true | true |
| **mybatis.configuration.default-statement-timeout** | 30000 | 25000 | 20000 | 15000 |
| **mybatis.configuration.default-executor-type** | reuse | reuse | reuse | reuse |

#### 定时任务配置

| 配置项 | Development | Testing | Staging | Production |
|--------|-------------|---------|---------|------------|
| **inspection.schedule.enabled** | false | true | true | true |
| **inspection.schedule.fixedRate** | - | 300000 | 60000 | 60000 |
| **inspection.schedule.initialDelay** | - | 60000 | 30000 | 10000 |

#### 跨域配置

| 配置项 | Development | Testing | Staging | Production |
|--------|-------------|---------|---------|------------|
| **cors.allowed-origins** | * | http://localhost:* | https://*.test.com | https://*.company.com |
| **cors.allowed-methods** | * | GET,POST,PUT,DELETE | GET,POST,PUT,DELETE | GET,POST,PUT,DELETE |
| **cors.allowed-headers** | * | * | Content-Type,Authorization | Content-Type,Authorization |
| **cors.max-age** | 3600 | 3600 | 7200 | 7200 |

### 应用配置详解

#### 1.1 DashScope AI配置

```yaml
dashscope:
  api:
    model: qwen-vl-max              # AI模型版本
    key: ${DASHSCOPE_API_KEY}       # API密钥，通过环境变量注入
    url: https://dashscope.alibaba-inc.com/api/v1  # API端点
    timeout: 20000                  # 请求超时时间（毫秒）
    retry:
      enabled: true                 # 是否启用重试
      maxAttempts: 3               # 最大重试次数
      backoffDelay: 1000           # 重试间隔（毫秒）
```

**配置说明**
- **model**: 指定使用的AI模型版本，qwen-vl-max支持多模态分析
- **key**: API访问密钥，生产环境通过环境变量注入，确保安全性
- **url**: AI服务的API端点地址
- **timeout**: 单次请求的超时时间，根据环境调整
- **retry**: 重试配置，提高服务可用性

#### 1.2 数据库连接配置

```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=false
    driver-class-name: org.h2.Driver
    username: sa
    password: 
    hikari:                         # 连接池配置
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  
  h2:
    console:
      enabled: true                 # 开发环境启用H2控制台
      path: /h2-console
      settings:
        web-allow-others: false     # 安全配置，禁止外部访问
```

**连接池优化**
- **maximum-pool-size**: 最大连接数，根据并发量调整
- **minimum-idle**: 最小空闲连接数，保证响应速度
- **connection-timeout**: 连接获取超时时间
- **idle-timeout**: 空闲连接超时时间
- **max-lifetime**: 连接最大生存时间

#### 1.3 MyBatis配置优化

```yaml
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: org.example.entity
  configuration:
    map-underscore-to-camel-case: true    # 自动驼峰转换
    cache-enabled: true                   # 启用二级缓存
    lazy-loading-enabled: true            # 启用懒加载
    aggressive-lazy-loading: false        # 关闭积极懒加载
    multiple-result-sets-enabled: true    # 支持多结果集
    use-column-label: true                # 使用列标签
    use-generated-keys: true              # 使用生成的主键
    default-executor-type: reuse          # 执行器类型
    default-statement-timeout: 25000      # 语句超时时间
    default-fetch-size: 100               # 默认抓取大小
    safe-row-bounds-enabled: true         # 安全的行边界
```

**性能优化配置**
- **cache-enabled**: 启用二级缓存，提高查询性能
- **lazy-loading-enabled**: 懒加载，减少不必要的数据库查询
- **default-fetch-size**: 批量获取记录数，优化大数据量查询
- **default-executor-type**: 使用reuse执行器，重用PreparedStatement

### 开关配置

#### 2.1 功能开关配置

| 开关名称 | 开关描述 | 默认值 | 影响范围 | 命名空间 |
|---------|---------|--------|---------|----------|
| **INSPECTION_SCHEDULE_ENABLED** | 巡检定时任务开关 | true | 自动化巡检功能 | app |
| **AI_ANALYSIS_ENABLED** | AI分析功能开关 | true | AI智能分析 | app |
| **SCREENSHOT_ENABLED** | 页面截图功能开关 | true | 页面截图巡检 | app |
| **CORS_ENABLED** | 跨域访问开关 | true | 前端跨域请求 | app |
| **H2_CONSOLE_ENABLED** | H2控制台开关 | false | 数据库管理界面 | app |

#### 2.2 巡检任务开关配置

| 开关名称 | 开关描述 | 默认值 | 影响范围 | 命名空间 |
|---------|---------|--------|---------|----------|
| **enablePageInspection** | 页面巡检开关 | true | 页面类型巡检任务 | InspectionJob |
| **enableApiInspection** | API巡检开关 | false | API类型巡检任务 | InspectionJob |
| **enableAutoRetry** | 自动重试开关 | true | 失败任务自动重试 | InspectionJob |
| **enableResultFilter** | 结果过滤开关 | true | AI结果智能过滤 | InspectionJob |
| **enableScreenshotCompress** | 截图压缩开关 | true | 截图文件压缩 | InspectionJob |

#### 2.3 AI服务开关配置

| 开关名称 | 开关描述 | 默认值 | 影响范围 | 命名空间 |
|---------|---------|--------|---------|----------|
| **aiServiceEnabled** | AI服务总开关 | true | 所有AI相关功能 | AI |
| **multiModalEnabled** | 多模态分析开关 | true | 图像+文本分析 | AI |
| **promptCacheEnabled** | Prompt缓存开关 | true | 提示词缓存机制 | AI |
| **resultCacheEnabled** | 结果缓存开关 | false | AI分析结果缓存 | AI |
| **costControlEnabled** | 成本控制开关 | true | AI调用频次控制 | AI |

#### 2.4 数据库开关配置

| 开关名称 | 开关描述 | 默认值 | 影响范围 | 命名空间 |
|---------|---------|--------|---------|----------|
| **enableSqlLog** | SQL日志开关 | false | MyBatis SQL日志 | Database |
| **enableSlowQueryLog** | 慢查询日志开关 | true | 性能监控 | Database |
| **enableConnectionPool** | 连接池监控开关 | true | 连接池状态监控 | Database |
| **enableTransactionLog** | 事务日志开关 | false | 事务执行日志 | Database |

#### 2.5 安全和监控开关配置

| 开关名称 | 开关描述 | 默认值 | 影响范围 | 命名空间 |
|---------|---------|--------|---------|----------|
| **securityEnabled** | 安全验证开关 | false | API安全验证 | Security |
| **auditLogEnabled** | 审计日志开关 | true | 用户操作审计 | Security |
| **sensitiveDataMask** | 敏感数据脱敏开关 | true | 日志敏感信息脱敏 | Security |
| **performanceMonitor** | 性能监控开关 | true | 系统性能监控 | Monitor |
| **errorAlertEnabled** | 错误告警开关 | true | 异常错误告警 | Monitor |

### 配置管理最佳实践

#### 3.1 环境变量管理

```bash
# 生产环境环境变量示例
export DASHSCOPE_API_KEY=your-production-api-key
export DB_PASSWORD=your-database-password
export SPRING_PROFILES_ACTIVE=prod
export SERVER_PORT=8080
export LOG_LEVEL=WARN
```

**安全配置原则**
- **敏感信息**: 通过环境变量注入，不在代码中硬编码
- **分离原则**: 配置与代码分离，支持不同环境配置
- **版本控制**: 配置文件纳入版本控制，敏感信息除外
- **权限控制**: 生产环境配置文件权限严格控制

#### 3.2 配置热更新

系统支持部分配置的热更新，无需重启应用：

**支持热更新的配置**
- 日志级别配置
- 定时任务间隔配置
- AI服务超时配置
- 功能开关配置

**不支持热更新的配置**
- 数据库连接配置
- 端口配置
- 安全配置
- 核心框架配置

#### 3.3 配置验证和监控

**配置验证机制**
- 启动时自动验证配置完整性
- 关键配置缺失时阻止应用启动
- 配置格式验证和类型检查
- 依赖配置一致性检查

**配置监控**
- 配置使用情况统计
- 配置变更历史记录
- 异常配置告警通知
- 配置性能影响分析

> **注意**: 
> - 所有开关配置通过`@Value`、`@ConfigurationProperties`注解管理
> - 支持配置文件的多环境profile机制
> - 生产环境配置需要严格的变更审批流程
> - 建议使用配置中心统一管理线上配置
