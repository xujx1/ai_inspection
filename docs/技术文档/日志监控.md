# AI智能巡检系统 - 监控与运维

## 监控与运维

### 日志配置

#### 日志架构概述
AI智能巡检系统采用分层日志架构，通过不同级别和类型的日志，实现系统运行状态监控、性能分析、异常排查等功能。系统基于Spring Boot的Logback框架，支持灵活的日志配置和输出格式定制。

#### 日志级别配置
- **全局日志级别**: INFO
- **业务模块日志**: INFO  
- **AI服务调用**: DEBUG
- **数据库操作**: DEBUG
- **异常错误**: ERROR
- **定时任务**: WARN

#### 专门化日志输出

##### 业务模块日志
| 日志Topic | 文件路径 | 用途 | 保留策略 | 格式特点 |
|----------|----------|------|----------|----------|
| **AI_INSPECTION** | `ai_inspection.log` | 主业务日志，记录巡检流程 | 7天 | 包含traceId和用户信息 |
| **TAG_MANAGEMENT** | `tag_management.log` | 标签管理业务日志 | 15天 | 标准业务日志格式 |
| **PROMPT_MANAGEMENT** | `prompt_management.log` | Prompt管理业务日志 | 15天 | 标准业务日志格式 |
| **RESULT_MANAGEMENT** | `result_management.log` | 巡检结果业务日志 | 30天 | 包含完整的结果数据 |
| **SCHEDULER_LOG** | `scheduler.log` | 定时任务执行日志 | 15天 | 任务调度专用格式 |

##### 监控专用日志
| 日志Topic | 文件路径 | 监控用途 | 实现方式 | 数据格式 |
|----------|----------|----------|----------|----------|
| **AI_SERVICE_MONITOR** | `ai_service_monitor.log` | AI服务调用监控 | AOP切面监控 | `traceId\|model\|costTime\|success\|errorMsg\|requestSize\|responseSize` |
| **PERFORMANCE_MONITOR** | `performance_monitor.log` | 系统性能监控 | Spring Actuator | `timestamp\|endpoint\|method\|costTime\|status\|userAgent` |
| **ERROR_MONITOR** | `error_monitor.log` | 异常错误监控 | 全局异常处理器 | `traceId\|level\|exception\|message\|stackTrace\|userId\|ip` |
| **BUSINESS_MONITOR** | `business_monitor.log` | 业务指标监控 | 自定义监控组件 | `traceId\|businessType\|operation\|success\|costTime\|errorCode` |

##### AI服务专用日志
| 日志Topic | 文件路径 | 用途 | 特点 |
|----------|----------|------|------|
| **DASHSCOPE_API** | `dashscope_api.log` | DashScope API调用日志 | 15天保留，包含请求响应详情 |
| **AI_ANALYSIS** | `ai_analysis.log` | AI分析过程日志 | 30天保留，记录分析逻辑和结果 |
| **PROMPT_EXECUTION** | `prompt_execution.log` | Prompt执行日志 | 15天保留，记录Prompt使用情况 |

#### 日志轮转策略

##### 标准轮转配置
- **应用主日志**: 按天+大小轮转，单文件100MB，总容量2GB，保留7天
- **业务日志**: 按天轮转，根据重要性保留7-30天
- **监控日志**: 按天轮转，保留15天
- **错误日志**: 按天+大小轮转，单文件50MB，总容量1GB，保留30天

##### 特殊配置
```xml
<!-- AI服务监控日志配置 -->
<appender name="AI_SERVICE_MONITOR" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>${LOG_PATH}/ai_service_monitor.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <fileNamePattern>${LOG_PATH}/ai_service_monitor.log.%d{yyyy-MM-dd}</fileNamePattern>
        <maxHistory>15</maxHistory>
        <totalSizeCap>1GB</totalSizeCap>
    </rollingPolicy>
    <encoder>
        <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
    </encoder>
</appender>

<!-- 错误监控日志配置 -->
<appender name="ERROR_MONITOR" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>${LOG_PATH}/error_monitor.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
        <fileNamePattern>${LOG_PATH}/error_monitor.log.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
        <maxHistory>30</maxHistory>
        <maxFileSize>50MB</maxFileSize>
        <totalSizeCap>1GB</totalSizeCap>
    </rollingPolicy>
    <encoder>
        <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
    </encoder>
</appender>
```

### 监控指标体系

#### AI服务监控
通过`@AIServiceMonitor`注解的AOP切面实现：
- **调用成功率**: 记录AI服务调用成功和失败次数
- **响应时间监控**: 监控AI服务响应时间分布
- **请求大小统计**: 统计图片大小和请求参数大小
- **错误分类统计**: 按错误类型分类统计异常情况
- **成本分析**: 记录AI服务调用成本和频次

#### 业务流程监控  
通过业务埋点监控关键流程：
- **巡检任务监控**: 任务创建、执行、完成的全流程监控
- **截图生成监控**: 页面截图成功率和质量监控
- **数据分析监控**: AI分析结果的准确性和完整性
- **用户操作监控**: 前端用户操作行为和路径分析

#### 系统性能监控
- **JVM监控**: 内存使用、GC频次、线程数量等
- **数据库监控**: 连接池状态、查询耗时、慢查询统计
- **接口性能**: 各API接口的响应时间和吞吐量
- **资源监控**: CPU、内存、磁盘、网络使用情况

#### 定时任务监控
- **任务执行状态**: 成功、失败、超时状态监控
- **执行耗时统计**: 各类巡检任务的执行时间分析
- **并发任务监控**: 同时执行的任务数量和资源占用
- **任务调度延迟**: 计划执行时间与实际执行时间差异

### 告警配置

#### 严重告警 (ERROR_MONITOR)
触发场景：
- **AI服务异常**: DashScope API调用失败或超时
- **数据库异常**: 连接池耗尽、查询超时、事务失败
- **巡检任务失败**: 定时任务执行异常、截图失败
- **系统资源异常**: 内存溢出、磁盘空间不足
- **安全异常**: 非法访问、数据泄露风险

#### 业务监控告警
- **AI分析质量**: 分析结果异常率超过10%时告警
- **巡检任务积压**: 待处理任务数量超过阈值告警
- **用户操作异常**: 频繁操作失败或异常行为告警
- **数据一致性**: 数据不一致或完整性问题告警

#### 性能告警
- **响应时间**: API响应时间P95超过3秒告警
- **AI服务延迟**: AI分析响应时间超过30秒告警
- **数据库性能**: 慢查询频率超过5%告警
- **系统资源**: CPU使用率超过80%或内存使用率超过90%告警

### 性能监控

#### 关键指标
- **接口响应时间**: P99 < 5秒，P95 < 3秒，P90 < 2秒
- **AI服务调用**: 图像分析 < 30秒，文本处理 < 10秒
- **数据库查询**: 复杂查询 < 10秒，简单查询 < 1秒
- **定时任务**: 单次巡检任务 < 60秒，批量任务 < 300秒

#### 监控维度
- **用户维度**: 按操作用户统计使用行为和性能
- **功能维度**: 按业务功能模块统计成功率和耗时
- **时间维度**: 按小时/天统计趋势和峰值情况
- **环境维度**: 区分开发、测试、生产环境的性能表现

#### 性能优化建议
- **缓存策略**: 对频繁查询的数据实施缓存机制
- **异步处理**: 耗时操作采用异步处理，提升响应速度
- **连接池优化**: 根据并发量调整数据库连接池配置
- **资源管理**: 及时释放临时资源，避免内存泄露

### 运维支持

#### 日志查询和分析
- **关键字检索**: 支持按traceId、用户ID、时间范围等维度检索
- **错误日志聚合**: 相同类型错误自动聚合分析
- **性能趋势分析**: 基于历史日志数据分析性能趋势
- **业务数据统计**: 自动生成业务指标报表和统计数据

#### 故障排查工具
- **分层日志**: 按Controller、Service、Mapper分层记录执行路径
- **上下文追踪**: 记录用户、请求参数、业务上下文等关键信息
- **异常堆栈**: 完整的异常堆栈信息和调用链追踪
- **实时监控**: 提供实时的系统状态监控面板

#### 运维自动化
- **健康检查**: 自动检查各组件健康状态
- **自动重启**: 检测到异常时自动重启相关服务
- **资源清理**: 定期清理临时文件和过期数据
- **备份恢复**: 自动备份关键数据和配置信息

### 监控最佳实践

#### 日志规范
- **统一格式**: 所有日志采用统一的格式标准
- **结构化**: 关键业务日志采用JSON格式，便于解析
- **脱敏处理**: 敏感信息自动脱敏，保护数据安全
- **分级记录**: 根据重要性分级记录，避免日志爆炸

#### 告警策略
- **分级告警**: 按严重程度设置不同的告警级别
- **智能去重**: 相同告警在短时间内去重处理
- **升级机制**: 高级别告警自动升级和通知机制
- **恢复通知**: 问题解决后自动发送恢复通知

#### 数据保留
- **热数据**: 近期数据保留在高速存储中
- **冷数据**: 历史数据归档到低成本存储
- **关键数据**: 重要业务数据永久保留
- **清理策略**: 自动清理过期的临时数据和日志

> **注意**: 
> - 所有监控组件支持云原生部署和容器化运行
> - 生产环境告警需要24小时响应机制
> - 敏感日志信息已按照安全规范进行脱敏处理
> - 监控数据定期备份，确保数据安全和可恢复性
