<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 巡检Prompt管理</title>
    <link rel="stylesheet" href="css/index.css">
    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://unpkg.com/antd@4.24.15/dist/antd.min.css">
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Ant Design JavaScript -->
    <script src="https://unpkg.com/antd@4.24.15/dist/antd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Table, Button, Input, Form, Modal, message, Spin, Tag, Select, Popconfirm } = antd;

        // API 调用函数
        const tagApi = {
            queryValidTags: async () => {
                try {
                    const response = await fetch('/api/tag/valid', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: API服务器未响应`);
                    }
                    const result = await response.json();
                    if (result.success) {
                        return result.content || [];
                    } else {
                        console.error('查询标签失败:', result.errorMsg);
                        return [];
                    }
                } catch (error) {
                    console.error('查询标签API调用错误:', error);
                    return [];
                }
            }
        };

        const promptApi = {
            queryPromptList: async (queryParams = {}) => {
                try {
                    console.log('调用API /api/prompt/query，参数:', queryParams);
                    
                    const response = await fetch('/api/prompt/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(queryParams)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: API服务器未响应`);
                    }
                    
                    const result = await response.json();
                    console.log('API响应:', result);
                    
                    if (result.success) {
                        return result.content || [];
                    } else {
                        console.error('查询失败:', result.errorMsg);
                        throw new Error(result.errorMsg || '查询失败');
                    }
                } catch (error) {
                    console.error('API调用错误:', error);
                    console.warn('API不可用，返回空数据。请启动Spring Boot应用以获取真实数据。');
                    return [];
                }
            },
            
            addPrompt: async (data) => {
                try {
                    const response = await fetch('/api/prompt/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('新增API调用错误:', error);
                    throw error;
                }
            },
            
            updatePrompt: async (data) => {
                try {
                    const response = await fetch('/api/prompt/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('更新API调用错误:', error);
                    throw error;
                }
            },
            
            deletePrompt: async (id) => {
                try {
                    const response = await fetch(`/api/prompt/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('删除API调用错误:', error);
                    throw error;
                }
            }
        };

        const PromptManagement = () => {
            const [tableDataList, setTableDataList] = useState([]);
            const [tableLoading, setTableLoading] = useState(false);
            const [modalVisible, setModalVisible] = useState(false);
            const [editMode, setEditMode] = useState(false);
            const [formData, setFormData] = useState({});
            const [modalLoading, setModalLoading] = useState(false);
            
            // 解析URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const tagFromUrl = urlParams.get('tag') || '';
            const tagNameFromUrl = urlParams.get('tagName') || '';
            const hideTagSelect = urlParams.get('hideTagSelect') === 'true';
            
            const [queryParams, setQueryParams] = useState({
                tag: tagFromUrl,
                promptName: '',
                methodName: ''
            });
            const [tagOptions, setTagOptions] = useState([]);

            useEffect(() => {
                queryTableList();
                loadTagOptions();
            }, []);

            const loadTagOptions = async () => {
                try {
                    const tags = await tagApi.queryValidTags();
                    setTagOptions(tags);
                } catch (error) {
                    console.error('加载标签选项失败:', error);
                }
            };

            const queryTableList = async () => {
                setTableLoading(true);
                try {
                    const results = await promptApi.queryPromptList(queryParams);
                    setTableDataList(results || []);
                    setTableLoading(false);
                } catch (error) {
                    console.error('查询失败:', error);
                    message.error(`查询失败: ${error.message}`);
                    setTableLoading(false);
                }
            };

            // 新增功能
            const handleAdd = () => {
                setEditMode(false);
                setFormData({
                    tag: hideTagSelect ? tagFromUrl : '',
                    promptName: '',
                    methodName: '',
                    promptContent: ''
                });
                setModalVisible(true);
            };

            // 编辑功能
            const handleEdit = (record) => {
                setEditMode(true);
                setFormData({
                    id: record.id,
                    tag: record.tag,
                    promptName: record.promptName,
                    methodName: record.methodName,
                    promptContent: record.promptContent
                });
                setModalVisible(true);
            };

            // 删除功能
            const handleDelete = async (record) => {
                try {
                    const result = await promptApi.deletePrompt(record.id);
                    if (result.success) {
                        message.success('删除成功');
                        queryTableList();
                    } else {
                        message.error(result.errorMsg || '删除失败');
                    }
                } catch (error) {
                    console.error('删除失败:', error);
                    message.error(`删除失败: ${error.message}`);
                }
            };

            // 保存功能
            const handleSave = async () => {
                setModalLoading(true);
                try {
                    let result;
                    if (editMode) {
                        result = await promptApi.updatePrompt(formData);
                    } else {
                        result = await promptApi.addPrompt(formData);
                    }
                    
                    if (result.success) {
                        message.success(editMode ? '更新成功' : '新增成功');
                        setModalVisible(false);
                        queryTableList();
                    } else {
                        message.error(result.errorMsg || (editMode ? '更新失败' : '新增失败'));
                    }
                } catch (error) {
                    console.error('保存失败:', error);
                    message.error(`保存失败: ${error.message}`);
                } finally {
                    setModalLoading(false);
                }
            };

            // 取消功能
            const handleCancel = () => {
                setModalVisible(false);
                setFormData({});
            };

            const columns = [
                {
                    title: 'ID',
                    dataIndex: 'id',
                    key: 'id',
                    width: 80,
                },
                {
                    title: '业务类型',
                    dataIndex: 'tag',
                    key: 'tag',
                    width: 120,
                },
                {
                    title: 'Prompt名称',
                    dataIndex: 'promptName',
                    key: 'promptName',
                    width: 200,
                },
                {
                    title: '方法名',
                    dataIndex: 'methodName',
                    key: 'methodName',
                    width: 150,
                },
                {
                    title: 'Prompt内容',
                    dataIndex: 'promptContent',
                    key: 'promptContent',
                    width: 400,
                    render: (text) => {
                        if (!text) return '-';
                        const maxLength = 100;
                        const displayText = text.length > maxLength ? `${text.substring(0, maxLength)}...` : text;
                        return React.createElement(antd.Tooltip, {
                            title: text,
                            placement: 'topLeft'
                        }, displayText);
                    },
                },
                {
                    title: '创建时间',
                    dataIndex: 'gmtCreate',
                    key: 'gmtCreate',
                    width: 180,
                },
                {
                    title: '更新时间',
                    dataIndex: 'gmtModified',
                    key: 'gmtModified',
                    width: 180,
                },
                {
                    title: '操作',
                    key: 'action',
                    width: 200,
                    render: (text, record) => (
                        React.createElement('div', null,
                            React.createElement(Button, {
                                type: 'link',
                                size: 'small',
                                onClick: () => handleEdit(record)
                            }, '编辑'),
                            React.createElement(Popconfirm, {
                                title: '确定要删除这条记录吗？',
                                onConfirm: () => handleDelete(record),
                                okText: '确定',
                                cancelText: '取消'
                            },
                                React.createElement(Button, {
                                    type: 'link',
                                    size: 'small',
                                    danger: true
                                }, '删除')
                            )
                        )
                    ),
                },
            ];

            return React.createElement('div', { className: 'promptRole' },
                React.createElement('div', { className: 'promptRole-header' },
                    React.createElement('h2', null, hideTagSelect ? `${tagNameFromUrl}(${tagFromUrl}) - AI 巡检Prompt管理` : 'AI 巡检Prompt管理')
                ),
                React.createElement('div', { style: { padding: '24px' } },
                    React.createElement(Form, { layout: 'inline', style: { marginBottom: '16px' } },
                        !hideTagSelect ? React.createElement(Form.Item, { label: '业务类型' },
                            React.createElement(Input, {
                                placeholder: '请输入业务类型',
                                value: queryParams.tag,
                                onChange: (e) => setQueryParams({...queryParams, tag: e.target.value}),
                                allowClear: true,
                                style: { width: 200 }
                            })
                        ) : null,
                        React.createElement(Form.Item, { label: 'Prompt名称' },
                            React.createElement(Input, {
                                placeholder: '请输入Prompt名称',
                                value: queryParams.promptName,
                                onChange: (e) => setQueryParams({...queryParams, promptName: e.target.value}),
                                allowClear: true,
                                style: { width: 200 }
                            })
                        ),
                        React.createElement(Form.Item, { label: '方法名' },
                            React.createElement(Input, {
                                placeholder: '请输入方法名',
                                value: queryParams.methodName,
                                onChange: (e) => setQueryParams({...queryParams, methodName: e.target.value}),
                                allowClear: true,
                                style: { width: 200 }
                            })
                        ),
                        React.createElement(Form.Item, null,
                            React.createElement(Button, {
                                type: 'primary',
                                onClick: () => queryTableList()
                            }, '查询')
                        ),
                        React.createElement(Form.Item, null,
                            React.createElement(Button, {
                                onClick: () => {
                                    const resetParams = { tag: '', promptName: '', methodName: ''};
                                    setQueryParams(resetParams);
                                    setTimeout(() => {
                                        setTableLoading(true);
                                        promptApi.queryPromptList(resetParams)
                                            .then(results => {
                                                setTableDataList(results || []);
                                                setTableLoading(false);
                                            })
                                            .catch(error => {
                                                console.error('查询失败:', error);
                                                message.error(`查询失败: ${error.message}`);
                                                setTableLoading(false);
                                            });
                                    }, 100);
                                }
                            }, '重置')
                        )
                    ),
                    React.createElement('div', { style: { marginBottom: '16px' } },
                        React.createElement(Button, {
                            type: 'primary',
                            onClick: handleAdd,
                            style: { marginBottom: '16px' }
                        }, '新增Prompt')
                    ),
                    React.createElement(Table, {
                        columns: columns,
                        dataSource: tableDataList,
                        rowKey: 'id',
                        loading: tableLoading,
                        scroll: { x: 1200 },
                        pagination: {
                            showSizeChanger: true,
                            showQuickJumper: true,
                            showTotal: (total) => `共 ${total} 条记录`,
                        }
                    }),
                    // 新增/编辑弹窗
                    React.createElement(Modal, {
                        title: editMode ? '编辑Prompt' : '新增Prompt',
                        open: modalVisible,
                        onOk: handleSave,
                        onCancel: handleCancel,
                        confirmLoading: modalLoading,
                        width: 800
                    },
                        React.createElement(Form, { layout: 'vertical' },
                            React.createElement('div', { style: { display: 'flex', gap: '16px' } },
                                React.createElement('div', { style: { flex: 1 } },
                                    React.createElement(Form.Item, { label: '业务类型' },
                                        hideTagSelect ? 
                                            React.createElement(Input, {
                                                value: `${tagNameFromUrl}(${tagFromUrl})`,
                                                disabled: true,
                                                style: { width: '100%' }
                                            }) :
                                            React.createElement(Select, {
                                                value: formData.tag,
                                                onChange: (value) => setFormData({...formData, tag: value}),
                                                placeholder: '请选择业务类型',
                                                style: { width: '100%' }
                                            },
                                                ...tagOptions.map(tag => 
                                                    React.createElement(Select.Option, { 
                                                        key: tag.tag, 
                                                        value: tag.tag 
                                                    }, `${tag.tagName}(${tag.tag})`)
                                                )
                                            )
                                    )
                                ),
                                React.createElement('div', { style: { flex: 1 } },
                                    React.createElement(Form.Item, { label: '方法名' },
                                        React.createElement(Input, {
                                            value: formData.methodName,
                                            onChange: (e) => setFormData({...formData, methodName: e.target.value}),
                                            placeholder: '请输入方法名'
                                        })
                                    )
                                )
                            ),
                            React.createElement(Form.Item, { label: 'Prompt名称' },
                                React.createElement(Input, {
                                    value: formData.promptName,
                                    onChange: (e) => setFormData({...formData, promptName: e.target.value}),
                                    placeholder: '请输入Prompt名称'
                                })
                            ),
                            React.createElement(Form.Item, { label: 'Prompt内容' },
                                React.createElement(antd.Input.TextArea, {
                                    value: formData.promptContent,
                                    onChange: (e) => setFormData({...formData, promptContent: e.target.value}),
                                    placeholder: '请输入Prompt内容',
                                    rows: 8
                                })
                            )
                        )
                    )
                )
            );
        };

        // 渲染应用
        ReactDOM.render(React.createElement(PromptManagement), document.getElementById('root'));
    </script>
</body>
</html>